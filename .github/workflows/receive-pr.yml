name: receive-pr

on:
  pull_request:
    types: [opened, synchronize]
    branches:
      - main

concurrency:
  group: '${{ github.workflow }} @ ${{ github.ref }}'
  cancel-in-progress: true

# https://securitylab.github.com/research/github-actions-preventing-pwn-requests/
# Since this pull request receives untrusted code, we should **NOT** have any secrets in the environment.
jobs:
  upload-patch:
    uses: openrewrite/gh-automation/.github/workflows/receive-pr.yml@main
    with:
      recipe: 'org.openrewrite.recipes.rewrite.OpenRewriteRecipeBestPracticesSubset'
      init_gradle: |
        initscript {
          repositories {
            maven { url 'https://plugins.gradle.org/m2' }
          }
          dependencies {
            classpath('org.openrewrite:plugin:latest.release')
          }
        }
        rootProject {
          // Apply plugin to all projects except rewrite-java-25
          configure(allprojects.findAll { it.name != 'rewrite-java-25' }) {
            plugins.apply(org.openrewrite.gradle.RewritePlugin)
          }
          dependencies {
              rewrite('org.openrewrite.recipe:rewrite-rewrite:latest.release')
          }
          afterEvaluate {
            if (repositories.isEmpty()) {
              repositories {
                mavenCentral()
              }
            }
          }
        }
