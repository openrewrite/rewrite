#
# Copyright 2023 the original author or authors.
# <p>
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# <p>
# https://www.apache.org/licenses/LICENSE-2.0
# <p>
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.BestPractices
displayName: Apache Maven best practices
description: Applies best practices to Maven POMs.
recipeList:
  - org.openrewrite.maven.cleanup.ExplicitDependencyVersion
  - org.openrewrite.maven.cleanup.ExplicitPluginGroupId
  - org.openrewrite.maven.cleanup.ExplicitPluginVersion
  - org.openrewrite.maven.cleanup.PrefixlessExpressions
  - org.openrewrite.maven.OrderPomElements
  - org.openrewrite.maven.RemoveDuplicateDependencies
  - org.openrewrite.maven.RemoveRedundantDependencyVersions
  - org.openrewrite.maven.cleanup.RemoveUnnecessaryExclusions
  - org.openrewrite.maven.RemoveRedundantProperties:
      onlyIfValuesMatch: true
  - org.openrewrite.maven.plugin.DependencyPluginGoalResolveSources
  - org.openrewrite.maven.UpdateScmFromGitOrigin
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.cleanup.PrefixlessExpressions
displayName: Drop prefixless expressions in POM
description: MNG-7404 drops support for prefixless in POMs. This recipe will add the `project.` prefix where missing.
recipeList:
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: basedir
      newKey: project.basedir
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: build.timestamp
      newKey: project.build.timestamp
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: groupId
      newKey: project.groupId
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: artifactId
      newKey: project.artifactId
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: version
      newKey: project.version
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: pom.version
      newKey: project.version
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.MigrateToMaven4
displayName: Migrate to Maven 4
description: Migrates Maven POMs from Maven 3 to Maven 4, addressing breaking changes and deprecations. This recipe updates property expressions, lifecycle phases, removes duplicate plugin declarations, and replaces removed properties to ensure compatibility with Maven 4.
recipeList:
  - org.openrewrite.maven.cleanup.PrefixlessExpressions
  - org.openrewrite.maven.ReplaceRemovedRootDirectoryProperties
  - org.openrewrite.maven.ReplaceDeprecatedLifecyclePhases
  - org.openrewrite.maven.RemoveDuplicatePluginDeclarations
  - org.openrewrite.maven.UpgradeToModelVersion410
  - org.openrewrite.maven.ReplaceModulesWithSubprojects
  - org.openrewrite.maven.UseParentInference
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.ReplaceRemovedRootDirectoryProperties
displayName: Replace removed root directory properties
description: Maven 4 removed support for deprecated root directory properties. This recipe replaces `${executionRootDirectory}` with `${session.rootDirectory}` and `${multiModuleProjectDirectory}` with `${project.rootDirectory}`.
recipeList:
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: executionRootDirectory
      newKey: session.rootDirectory
  - org.openrewrite.maven.RenamePropertyKey:
      oldKey: multiModuleProjectDirectory
      newKey: project.rootDirectory
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.ReplaceDeprecatedLifecyclePhases
displayName: Replace deprecated lifecycle phases
description: Maven 4 deprecated all `pre-*` and `post-*` lifecycle phases in favor of the `before:` and `after:` syntax. This recipe updates plugin phase declarations to use the new syntax, including `pre-clean` → `before:clean`, `pre-site` → `before:site`, `pre-integration-test` → `before:integration-test`, and their `post-*` equivalents.
recipeList:
  - org.openrewrite.xml.ChangeTagValue:
      elementName: //plugins/plugin/executions/execution/phase
      oldValue: pre-clean
      newValue: before:clean
  - org.openrewrite.xml.ChangeTagValue:
      elementName: //plugins/plugin/executions/execution/phase
      oldValue: post-clean
      newValue: after:clean
  - org.openrewrite.xml.ChangeTagValue:
      elementName: //plugins/plugin/executions/execution/phase
      oldValue: pre-site
      newValue: before:site
  - org.openrewrite.xml.ChangeTagValue:
      elementName: //plugins/plugin/executions/execution/phase
      oldValue: post-site
      newValue: after:site
  - org.openrewrite.xml.ChangeTagValue:
      elementName: //plugins/plugin/executions/execution/phase
      oldValue: pre-integration-test
      newValue: before:integration-test
  - org.openrewrite.xml.ChangeTagValue:
      elementName: //plugins/plugin/executions/execution/phase
      oldValue: post-integration-test
      newValue: after:integration-test
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.UpgradeToModelVersion410
displayName: Upgrade to Maven model version 4.1.0
description: Upgrades Maven POMs from model version 4.0.0 to 4.1.0, enabling new Maven 4 features like `<subprojects>`, `bom` packaging, and automatic version inference. This recipe updates the `<modelVersion>` element, `xmlns` namespace, and `xsi:schemaLocation` from 4.0.0 to 4.1.0.
recipeList:
  - org.openrewrite.xml.ChangeTagValue:
      elementName: /project/modelVersion
      oldValue: 4.0.0
      newValue: 4.1.0
  - org.openrewrite.xml.ChangeTagAttribute:
      elementName: /project
      attributeName: xmlns
      oldValue: http://maven.apache.org/POM/4.0.0
      newValue: http://maven.apache.org/POM/4.1.0
  - org.openrewrite.xml.ChangeTagAttribute:
      elementName: /project
      attributeName: xsi:schemaLocation
      oldValue: (http://maven\.apache\.org/POM/)4\.0\.0(\s+http[s]?://maven\.apache\.org/xsd/maven-)4\.0\.0(\.xsd)
      newValue: $14.1.0$24.1.0$3
      regex: true
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.ReplaceModulesWithSubprojects
displayName: Replace modules with subprojects
description: Maven 4 model version 4.1.0 deprecates the `<modules>` element in favor of `<subprojects>` to eliminate confusion with Java's Platform Module System (JPMS). This recipe renames `<modules>` to `<subprojects>` and `<module>` children to `<subproject>`.
recipeList:
  - org.openrewrite.xml.ChangeTagName:
      elementName: /project/modules/module
      newName: subproject
  - org.openrewrite.xml.ChangeTagName:
      elementName: /project/modules
      newName: subprojects
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.RemoveMavenWrapper
displayName: Remove Maven wrapper
description: Remove Maven wrapper files from a project. This includes the `mvnw` and `mvnw.cmd` scripts, and the `.mvn/wrapper` directory.
recipeList:
  - org.openrewrite.DeleteSourceFiles:
      filePattern: "**/mvnw"
  - org.openrewrite.DeleteSourceFiles:
      filePattern: "**/mvnw.cmd"
  - org.openrewrite.DeleteSourceFiles:
      filePattern: "**/.mvn/wrapper/**"
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.maven.cleanup.RemoveUnnecessaryExclusions
displayName: Remove unnecessary exclusions
description: Remove exclusions that are not necessary because the excluded dependency is not a transitive dependency of the project.
recipeList:
  - org.openrewrite.maven.RemoveExclusion:
      groupId: "*"
      artifactId: "*"
      exclusionGroupId: "*"
      exclusionArtifactId: "*"
      onlyIneffective: true
